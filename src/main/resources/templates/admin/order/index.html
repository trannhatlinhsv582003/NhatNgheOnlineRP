<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>Quản lý đơn hàng</title>
	<link rel="shortcut icon" th:href="@{/images/logo/logo.png}" type="image/png">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Bootstrap -->
	<link rel="stylesheet" th:href="@{/libraries/bootstrap-5.3.3-dist/css/bootstrap.min.css}">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

	<!-- CSS Custom -->
	<link rel="stylesheet" th:href="@{/css/app.css}">
</head>

<body>
	<!-- HEADER -->
	<header class="row">
		<div th:replace="/components/_menu.html"></div>
	</header>

	<!-- BODY -->
	<div class="container-fluid">
		<div class="row">
			<!-- Sidebar -->
			<div th:replace="/components/_adminSidebar.html"></div>

			<!-- Main content -->
			<main class="col-md-10 ms-sm-auto px-4">
				<div class="container-fluid">
					<div class="pt-4">
						<h3 class="fw-bold mb-3">Quản lý đơn hàng</h3>
						<ul class="nav nav-tabs" id="orderTab" role="tablist">
							<li class="nav-item">
								<button class="nav-link text-black active" id="list-tab" data-bs-toggle="tab"
									data-bs-target="#list" type="button" role="tab">Danh sách đơn hàng</button>
							</li>
							<li class="nav-item">
								<button class="nav-link text-black" id="form-tab" data-bs-toggle="tab"
									data-bs-target="#form" type="button" role="tab">Chi tiết đơn hàng</button>
							</li>
						</ul>
						<div class="tab-content p-3 mb-3 rounded bg-white" id="orderTabContent">
							<!-- Tab Danh sách -->
							<div class="tab-pane fade show active" id="list" role="tabpanel">
								<div th:replace="/admin/order/_list.html"></div>
							</div>
							<!-- Tab Chi tiết -->
							<div class="tab-pane fade" id="form" role="tabpanel">
								<div th:replace="/admin/order/_form.html"></div>
							</div>
						</div>
					</div>
			</main>
		</div>
	</div>

	<!-- FOOTER -->
	<div th:replace="/components/_footer.html"></div>

	<script th:src="@{/libraries/bootstrap-5.3.3-dist/js/bootstrap.bundle.min.js}"></script>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			// Gắn sự kiện cho các nút "Xem đơn hàng"
			document.querySelectorAll('.btn-view').forEach(function (btn) {
				btn.addEventListener('click', function () {
					const row = this.closest('tr');
					const id = row.getAttribute('data-id');

					fetch('/admin/order/api/' + id)
						.then(res => res.json())
						.then(order => {
							// Populate thông tin đơn hàng
							document.getElementById('orderID').textContent = order.orderID;
							document.getElementById('customerName').textContent = order.user.fullName;

							console.log("Order Date:", order.orderDate);

							document.getElementById('orderDate').textContent = order.orderDate;

							document.getElementById('shippingAddress').textContent = order.shippingAddress;

							const items = order.orderItems || [];
							const tbody = document.getElementById('orderItems');
							tbody.innerHTML = '';

							items.forEach(item => {
								const row = document.createElement('tr');
								row.innerHTML = `
								<td>${item.product.productName}</td>
								<td>${item.quantity}</td>
								<td>${item.price.toLocaleString()} đ</td>
								<td>${(item.price * item.quantity).toLocaleString()} đ</td>
							`;
								tbody.appendChild(row);
							});

							document.getElementById('orderStatus').value = order.status;
							document.getElementById('orderIDField').value = order.orderID;

							// Chuyển sang tab form
							const tab = new bootstrap.Tab(document.querySelector('#form-tab'));
							tab.show();

							// Hiện chi tiết
							document.getElementById('orderDetailSection').style.display = 'block';
						});
				});
			});

			// Khi chuyển qua tab "Chi tiết" thủ công (nếu không thông qua nút Xem)
			document.getElementById('form-tab').addEventListener('shown.bs.tab', function () {
				document.getElementById('orderDetailSection').style.display = 'block';
			});
		});

		function validateBeforeSubmit() {
			const orderID = document.getElementById('orderIDField')?.value;
			if (!orderID) {
				showCustomMessage({
					title: 'Lỗi',
					message: 'Vui lòng chọn đơn hàng trước khi cập nhật trạng thái!',
					type: 'warning'
				});
				return false;
			}
			return true;
		}

	</script>

</body>

</html>