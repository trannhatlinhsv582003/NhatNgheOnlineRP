<!-- Modal Quên Mật Khẩu -->
<div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0 flex-column text-center position-relative">
        <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"
          aria-label="Close"></button>
        <h5 class="modal-title fw-bold w-100 mt-3">QUÊN MẬT KHẨU</h5>
      </div>

      <div class="modal-body px-4">

        <!-- Bước 1: Nhập email -->
        <div id="stepEmail">
          <p class="text-muted">Nhập email bạn đã đăng ký để nhận mã xác thực.</p>
          <input type="email" id="resetEmail" class="form-control mb-3" placeholder="Email đã đăng ký">

          <button id="sendOtpBtn" class="btn btn-danger w-100 fw-bold mb-3" onclick="sendOtp()">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"
              id="sendOtpSpinner"></span>
            <span id="sendOtpText">Gửi mã xác thực</span>
          </button>

        </div>

        <!-- Bước 2: Nhập OTP -->
        <div id="stepOtp" class="d-none">
          <p class="text-muted">Mã xác thực đã được gửi đến email.</p>
          <input type="text" id="otpCode" class="form-control mb-3" placeholder="Nhập mã OTP gồm 6 chữ số">
          <button class="btn btn-primary w-100 fw-bold mb-3" onclick="verifyOtp()">Xác nhận mã OTP</button>
        </div>

        <!-- Bước 3: Đổi mật khẩu -->
        <div id="stepNewPass" class="d-none">
          <p class="text-muted">Nhập mật khẩu mới để hoàn tất.</p>
          <input type="password" id="newPassword" class="form-control mb-3" placeholder="Mật khẩu mới">
          <input type="password" id="confirmPassword" class="form-control mb-3" placeholder="Xác nhận mật khẩu">
          <button class="btn btn-success w-100 fw-bold mb-3" onclick="resetPassword()">Đổi mật khẩu</button>
        </div>

        <!-- Quay lại -->
        <div class="text-center">
          <a href="#" class="small text-muted" data-bs-dismiss="modal" data-bs-toggle="modal"
            data-bs-target="#loginModal">Quay lại đăng nhập</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  let resetEmail = "";
  let verifiedOtp = false;

  function sendOtp() {
    const email = document.getElementById("resetEmail").value.trim();
    if (!email) return alert("Vui lòng nhập email.");

    const btn = document.getElementById("sendOtpBtn");
    const spinner = document.getElementById("sendOtpSpinner");
    const btnText = document.getElementById("sendOtpText");

    // Hiện loading và disable nút
    btn.disabled = true;
    spinner.classList.remove("d-none");
    btnText.textContent = "Đang gửi...";

    fetch("/auth/forgot-password/send-otp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    })
      .then(res => {
        if (!res.ok) throw new Error("Không gửi được mã. Kiểm tra lại email.");
        return res.text();
      })
      .then(() => {
        resetEmail = email;
        document.getElementById("stepEmail").classList.add("d-none");
        document.getElementById("stepOtp").classList.remove("d-none");
      })
      .catch(err => alert(err.message))
      .finally(() => {
        // Ẩn loading và enable lại nút
        btn.disabled = false;
        spinner.classList.add("d-none");
        btnText.textContent = "Gửi mã xác thực";
      });
  }


  function verifyOtp() {
    const otp = document.getElementById("otpCode").value.trim();
    if (!otp) return alert("Vui lòng nhập mã OTP.");

    fetch("/auth/forgot-password/verify-otp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: resetEmail, otp })
    })
      .then(res => {
        if (!res.ok) throw new Error("Mã OTP không chính xác hoặc đã hết hạn.");
        return res.text();
      })
      .then(() => {
        verifiedOtp = true;
        document.getElementById("stepOtp").classList.add("d-none");
        document.getElementById("stepNewPass").classList.remove("d-none");
      })
      .catch(err => alert(err.message));
  }

  function resetPassword() {
    const newPass = document.getElementById("newPassword").value.trim();
    const confirmPass = document.getElementById("confirmPassword").value.trim();

    if (!newPass || !confirmPass) return alert("Vui lòng nhập đầy đủ mật khẩu.");
    if (newPass !== confirmPass) return alert("Mật khẩu không khớp.");

    fetch("/auth/forgot-password/reset", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: resetEmail, newPassword: newPass })
    })
      .then(res => {
        if (!res.ok) throw new Error("Đổi mật khẩu thất bại.");
        return res.text();
      })
      .then(msg => {
        alert("Đổi mật khẩu thành công. Vui lòng đăng nhập lại.");
        const modal = bootstrap.Modal.getInstance(document.getElementById('forgotPasswordModal'));
        modal.hide();
      })
      .catch(err => alert(err.message));
  }
</script>